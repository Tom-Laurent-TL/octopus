"""Database migration utilities for schema updates."""
from sqlalchemy import inspect, text
from sqlalchemy.orm import Session
import logging

logger = logging.getLogger(__name__)


def check_and_add_column(db: Session, table_name: str, column_name: str, column_definition: str):
    """Check if a column exists and add it if it doesn't.
    
    Args:
        db: Database session
        table_name: Name of the table
        column_name: Name of the column to check/add
        column_definition: SQL definition for the column (e.g., "VARCHAR(45)")
    """
    inspector = inspect(db.bind)
    
    # Check if table exists
    if table_name not in inspector.get_table_names():
        logger.info(f"Table {table_name} doesn't exist yet, will be created by Base.metadata.create_all")
        return
    
    # Check if column exists
    columns = [col['name'] for col in inspector.get_columns(table_name)]
    
    if column_name not in columns:
        logger.info(f"Adding missing column {column_name} to {table_name}")
        try:
            # SQLite doesn't support all ALTER TABLE operations, so we use ADD COLUMN
            db.execute(text(f"ALTER TABLE {table_name} ADD COLUMN {column_name} {column_definition}"))
            db.commit()
            logger.info(f"Successfully added column {column_name} to {table_name}")
        except Exception as e:
            logger.error(f"Failed to add column {column_name} to {table_name}: {e}")
            db.rollback()
            raise
    else:
        logger.debug(f"Column {column_name} already exists in {table_name}")


def check_and_create_table(db: Session, table_name: str, create_sql: str):
    """Check if a table exists and create it if it doesn't.
    
    Args:
        db: Database session
        table_name: Name of the table to check/create
        create_sql: SQL CREATE TABLE statement
    """
    inspector = inspect(db.bind)
    
    if table_name not in inspector.get_table_names():
        logger.info(f"Creating missing table {table_name}")
        try:
            db.execute(text(create_sql))
            db.commit()
            logger.info(f"Successfully created table {table_name}")
        except Exception as e:
            logger.error(f"Failed to create table {table_name}: {e}")
            db.rollback()
            raise
    else:
        logger.debug(f"Table {table_name} already exists")


def run_migrations(db: Session):
    """Run all database migrations.
    
    This function checks for missing columns and tables and adds them if needed.
    Safe to run multiple times - it only adds what's missing.
    
    Args:
        db: Database session
    """
    logger.info("Checking for database schema updates...")
    
    # Migration 1: Add last_used_ip to api_keys table
    check_and_add_column(
        db, 
        "api_keys", 
        "last_used_ip", 
        "VARCHAR(45)"  # Supports both IPv4 and IPv6
    )
    
    # Migration 2: Add allowed_ips to api_keys table
    check_and_add_column(
        db, 
        "api_keys", 
        "allowed_ips", 
        "TEXT"  # Comma-separated list of allowed IPs
    )
    
    # Migration 3: Create api_key_audit_logs table if it doesn't exist
    # Note: This should be handled by Base.metadata.create_all, but we check anyway
    create_audit_log_table_sql = """
    CREATE TABLE IF NOT EXISTS api_key_audit_logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        api_key_id INTEGER,
        action VARCHAR(50) NOT NULL,
        performed_by_key_id INTEGER,
        performed_by_ip VARCHAR(45),
        details TEXT,
        timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY(api_key_id) REFERENCES api_keys (id),
        FOREIGN KEY(performed_by_key_id) REFERENCES api_keys (id)
    )
    """
    
    inspector = inspect(db.bind)
    if "api_key_audit_logs" not in inspector.get_table_names():
        logger.info("Creating api_key_audit_logs table")
        try:
            db.execute(text(create_audit_log_table_sql))
            db.commit()
            logger.info("Successfully created api_key_audit_logs table")
        except Exception as e:
            logger.error(f"Failed to create api_key_audit_logs table: {e}")
            db.rollback()
            raise
    
    # Migration 4: Add performed_by_key_id to existing api_key_audit_logs table
    check_and_add_column(
        db,
        "api_key_audit_logs",
        "performed_by_key_id",
        "INTEGER"
    )
    
    # Migration 5: Add performed_by_ip to existing api_key_audit_logs table
    # (old tables might have ip_address instead)
    check_and_add_column(
        db,
        "api_key_audit_logs",
        "performed_by_ip",
        "VARCHAR(45)"
    )
    
    logger.info("Database schema check complete")
